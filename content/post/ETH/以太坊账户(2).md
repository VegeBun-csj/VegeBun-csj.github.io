---
title: "以太坊账户(2)"
date: 2020-08-24T21:46:36+08:00
tags:
- 区块链
Categories:
- 以太坊
---

### 背景

比特币中采用的是**基于交易的账本**，这种模式下，系统中并**没有显式地记录账户中有多少钱** ，只能根据UTXO中的信息来推算。这种方式的隐私性较好，但是使用比较别扭，使用体验不是特别好，花钱的时候需要说明币的来源；还有就是每次花费比特币（一笔交易的输入必须将该输入来源的BTC全部花出去），然后多余的币转到另一个自己的地址。这就很麻烦！！！

### 以太坊账户

以太坊采用的是**基于账户的账本（account-based ledger）** ，它**有显式的余额的概念**，所以当进行交易转账的时候，只需要检查转出账户中是否有足够多的币，而无需说明转出的币具体来源于哪里。

```这种基于账户的账本模型有什么好处？
回想一下，为什么比特币要说明币的来源，因为要防范double spending，而以太坊这种基于账户的账本模式，有天然的防范double spending的作用。（花几次钱，扣几次钱，看账户有多少钱就行）
```

**这种账户的模式会不会有人发布交易修改自己的余额？**

答案是否定的，因为你发布交易的时候不需要说明你的账户余额，它是由系统中全节点维护的状态保存的。这是以太坊中一个重要的数据结构：状态树（即所有的账户的状态组成的一棵树，账户状态里包含的一个重要的域就是balance，也就是你的余额，这也余额没有办法篡改，如果你要改这个余额，必须是所有的全节点都认为你的余额发生了变化，否则其他节点是不认可的）

**这种账户的模式防范了双花攻击，是不是就没什么缺点了？**

账户模式的账本，虽然能够天然防范double spending attack，但是会受到 replay attack（重放攻击）

**什么是重放攻击？**

比如A转给B，10个以太币，A发布一个交易给网络，过段时间之后，A发布的交易被写入区块中，A会觉得这个转账交易已经完成了；如果B是恶意的节点，它此时又把A转给B，10个以太币者交易又在网上重新广播了一遍，其他节点一看又觉得A向B转账，所以又扣了一次A的钱，这样就扣了两次A的钱。

**重放攻击和双花攻击其实是对称类似的**

双花攻击其实是转账的人不诚实，他想花两次钱；重放攻击是收钱的人不老实，他想收两次钱。

比特币中没有出现重放攻击是因为，如果一旦出现重返攻击，就会出现双花攻击，所以显然是不行的。

**以太坊中如何防范重放攻击？**

加一个**计数器（nonce），即交易次数**，记录这个账户有史以来进行过多少次交易，然后转账的时候，这个交易次数要成为这个交易转账的一部分，一起包含进去，都是收到发布交易者签名保护的，其他人如果要伪造交易次数是没有签名的。所以系统中全节点维护的**状态树，不光要维护账户的状态，还要维护nonce的值**（账户创建的时候nonce的值是0，每次进行一次交易，nonce+1，全节点同时更新状态树中的nonce，以后如果有人重放交易，全节点检查状态树的nonce，如果已经执行过了，即nonce相同，就不会执行重放的交易）



# 账户的分类

- #### 外部账户(external owned account)：公私钥控制

  一个外部账户的状态包括：balance(余额)，nonce(计数)

- #### 合约账户(smart contract account)：

  一个合约可以调用另外一个合约，所以**合约要也有nonce值记录一下合约调用的次数**，但是**合约账户不能主动发起一个交易，所有的交易只能由外部账户发起。**外部账户发起一个交易，如果调用了一个合约账户，这个合约账户可以发送一个message，调用另外一个合约。

  一个合约账户包含：code（代码），storage（相关存储状态，包括每个变量的取值）



> BTC是基于UTXO的数据模型
>
> ETH是基于账户的数据模型