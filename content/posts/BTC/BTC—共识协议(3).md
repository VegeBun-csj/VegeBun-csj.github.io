---
title: "BTC—共识协议(3)"
date: 2020-08-23T20:07:04+08:00
tags:
- 区块链
Categories:
- 比特币
---

### 相对于传统的纸质货币，数字货币需要解决两个问题：

1.**谁来发行货币，什么时候发行，发行多少**（这是**挖矿**决定的）

2.**如何验证交易的有效性**，传统的纸质货币，花出去就是花出去了，但是BTC这类电子货币相对于传统的纸质货币，首先面临的最大的问题就是双重支付，也就是**“双花攻击”——double spending** **attack**，因为这种电子货币是文件，是可复制的，如何验证货币已经花出去了，**防止双重支付**，是需要解决的问题



## 一.如何验证交易的有效性

如何防止双花攻击，传统的纸质货币可以由央行来维护，是一个中心化的机构，但是在数字货币中，需要集体来维护一个数据结构，是一个去中心化的，所以就诞生了区块链这种数据结构

### 比特币系统中每个交易都包含输入和输出：

（1）输入：说明**币的来源，以及转账者的公钥**

（2）输出：给出**收款人的公钥的hash**（用于找到收款人的比特币地址，可以做成类似于二维码）

注意：此时由两种hash指针，**一种指针就是连接各个区块构成一个链的；另一种指针就是指向前面某个交易的，也就是为了说明币的来源的**，为什么要说明币的来源，就是为了说明币不是凭空捏造的，更重要的是**为了防止double spending**

注：在比特币系统中，每个交易的输入是一段**脚本（bitcoin Script）**，每个交易的输出也是一段脚本，当验证交易是不是合法时（是否双重支付），就是要把**当前交易的输入脚本**跟**前面那个交易的输出脚本**拼在一起，看能否顺利执行，如果能执行，就是合法的。

### **比特币区块的结构：**

一个区块分为**Block header和Block body**

**1.Block header**：其中包含了比特币协议的版本（version），指向前一个区块的hash（hash of previous Block header），整个Merkle tree的根hash值（Merkle root hash）,挖矿的难度目标预值（target）,随机数（nounce）

注：**H(Block header)<=Target**，即整个块头的hash要小于等于目标预值，block header中存的就是这个目标预值的编码（**nBits**）；指向前一个区块的hash（hash of previous Block header）是只算的区块头的hash，并没有区块体！！！！这个要特别注意

**2.Block body**：其中包含交易列表（transaction list）



### 比特币中的节点：

比特币中的节点分为：**全节点（full node）和轻节点（light node）**

**全节点**：保存区块链所有的信息，验证每一个交易，所以全节点也叫做**fully validation node**

**轻节点**：并不保存所有信息

比特币中所有的节点都可以进行交易，那这些**交易应该由谁来记账，如何记账**呢，这就是需要解决的问题，因为区块链是一个分布式的账本，这个账本必须要所有人都认同，不能各记各的帐，所以账本需要取得**分布式共识（distributed consensus）**

分布式共识一个简单的例子就是**分布式hash表（dstributed hash table——DHT）**,一个全局的hash表

在分布式系统中，有很多**不可能理论（impossiblity result）**,其中比较著名的有

**1.FLP不可能理论**，即在一个异步（asynchronous）的系统中,网络时延没有上限，即使只有一个成员有问题，也不可能取得共识。

**2.CAP不可能理论**，C代表Consistency一致性，A代表Availibility可用性，P代表Partition tolerance容错性，这个理论说明了这三种性质最多只能满足两个，也就是必须要牺牲其中的一个



### 比特币中的共识协议

比特币系统中有的节点是恶意的，那么这种情况下怎么设计共识协议。

只有找到符合**H(Block header)<=Target** 的nounce的节点才有记账权利，其他的节点则是验证

比特币中会出现分叉，只有**最长链才是合法**的，是为了防止**分叉攻击（forking attack）**，即通过分叉某个区块，来回滚已经发生的交易。当然分叉并非一定是恶意攻击，当出现多个节点在同一时刻同时计算出随机数nounce获得记账权，同时将区块写入账本中时就会出现分叉，这种分叉的情况会维持一段时间（看分叉的链中哪个先找到下一个区块），直到分叉链中的一条链胜出成为合法链（最长链）为止，这就是节点竞争获得记账权的过程，也就是共识的过程，大家都公认最长的链（账本）是正确的。

那为什么会出现这种竞争记账的现象呢？

因为有出块奖励（Block reward）！！！！也就是接下来要说的谁来发行货币



## 二.谁来发行货币

coinbase transaction（铸币交易） 是比特币系统当中发行新的比特币货币的唯一方法，其他所有的交易都只是把已有的账户的货币转到其他账户

一开始的时候，比特币系统中每写入一个区块，都有50BTC的奖励，但是规定每21万个区块之后，这个出块奖励就要减半



所以比特币中要取得的共识是去这个中心化账本中的内容，而谁能决定账本中的内容呢，只有获得记账权的节点才能往账本中写入，那如何获得记账权呢，就是解**H(Block header)<=Target** 这样一个难题(puzzle)这个puzzle没有捷径，只能一个一个去试，算出nounce，所以说，比特币的共识是靠算力的。所以如何一个节点的算力越大，那它获得记账权的概率就越大（hash rate决定了投票的权重），也就是靠算力来投票的，算力越大，获得记账的概率越大。所以基于算力的投票的共识可以防范女巫攻击（sybil attack，通过创建多个恶意节点进行投票获得共识），即使在一台机器上创建多个账户，并不会使hash rate 增加，并不会让节点每秒尝试的nounce的数目增加，并不会影响最终的共识结果



