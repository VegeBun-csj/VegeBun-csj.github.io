---
title: "BTC—分叉(8)"
date: 2020-08-23T20:10:23+08:00
tags:
- 区块链
Categories:
- 比特币
---

# BTC分叉(fork)

```什么是分叉？何时出现分叉
1.在挖矿时。如果两个peer几乎同时出了一个块，那就会出现一个暂时性的fork，这种fork成为state fork,它是在网络中自然发生的，是不可避免的一种分叉，当然之前说的forking attack也是属于这种state fork，只不过分叉攻击是人为的恶意分叉
2.当比特币的协议发生改变时，也会造成分叉，这种分叉称为protocal fork(协议分叉)
（根据协议修改内容的不同，分叉又分为硬分叉和软分叉）
```



# 分叉的分类

### Hard fork（硬分叉）

`当比特币中增加了某些新特性，一些节点没有升级更新新特性（旧区块），当BTC系统继续运行并产生新的区块时，旧节点就不会认可这些新节点产生的区块，这样，旧节点和新节点产生的区块就产生了分叉`

**区块的大小限制发生改变（Block size limit）**

由于比特币当前的区块大小限制为1M，如果粗略的来算，1M就为1000000bit，一笔交易的大小大约为250bit，所以算下来1000000bit/250bit= 4000笔交易/区块，又因为每10min产生一个区块（4000笔交易），所以每秒大约4000/60 = 7笔交易，所以这个交易量是非常小的。

所以就有人提议将区块大小改为4M，从而提高交易量，此处假设网络中的绝大部分算力的节点更新了这个特性

![硬分叉](/image/BTC/hardforking.png)

可以从图上看出来在Block3后面出现了分叉，此时旧节点是按照小区块记账，新节点按照大区快记账，但是**旧节点并不认可大区块，新节点认可小区块**（因为只要不超过4M，新节点都认可），所以会出现Block5小区块在Block_4后面（**因为新节点是绝大部分的算力，所以记账会由掌握绝大部分算力的新节点进行，所以在分叉的小区块后面不会出现小区块，而是会被新节点进行分叉，追加大区块，因为他们掌握了绝大部分的算力**），然后大区块Block_6在小区块Block5后面又会产生分叉，所以只要网络中有节点不更新新特性，就会产生这样永久性的断断续续的分叉（因为对于小区块而言，新旧节点都认可），即大区块中含有小区块的情况！！！（途中的黄色线是最长合法链）

`历史上，出现的经典的硬分叉的例子就是以太坊的The DAO事件，为了解决这个黑客攻击事件，以太坊不得不硬分叉，也就形成了现在的ETH和ETC（以太坊经典）并存的局面，ETC曾经是原来最纯正血统的以太坊，如今两个链分家，并且拥有自己的币！！！`



### Soft fork（软分叉）

**区块的大小限制发生改变（Block size limit）**

如果把区块的大小由1M改为0.5M，此时没有更新的节点（旧节点）仍然会打包1M大小的区块，而新节点会打包0.5M的区块，但是旧节点会认可新节点的区块，因为新节点的区块没有超过1M，所以掌握绝大部分的算力的新节点节点（假设绝大部分算力的节点更新了特性）会对小区块记账，同时旧节点也认可小区块，所以大家都会在小区块后面记账（**第一个分叉**），但是如果旧节点继续出大区块，那么依然会在大区块前面的这个小区块上面发生分叉，链上仍然会被小区块占领（**第二个分叉**，红色箭头是表示无效的追加区块），即分叉后的链上不会存在大区块，只要小区块，如果旧节点长时间不升级，就会导致自己挖矿的努力白费，频繁被分叉，会过的很难受。

![软分叉](/image/BTC/softforking.png)

所以，根据上面的两个例子，可以看出

- 硬分叉：必须半数以上算力的节点由新特性之后才不会出现永久性分叉
- 软分叉：只要系统中有半数的算力更新新特性，就不会出现永久性的分叉



> 如何简单地来区分硬分叉还是软分叉：只要是旧节点不接受新区块就会产生硬分叉，只要是旧节点可以接受新区块就不会产生硬分叉（软分叉）
>
> 2016年的以太坊的The DAO事件就是硬分叉的典型例子，一开始通过软分叉来解决问题，但是攻击者通过某些指令不消耗gas，大量发起交易进行攻击，导致矿工资源消耗严重，迫使矿工降为旧版本，从而使这一方案以失败告终，最终以太坊社区不得不采取硬分叉的方式，使得曾经的ETH分裂为ETH和ETC(以太坊经典classic，实际上ETC是根正苗红的ETH)，现在的ETH是分叉后回滚交易的ETH。（以太坊由此分为了两派，支持回滚交易的一派也就是现在的ETH，不支持回滚交易的一派是ETC，似乎也是两种不同思想的人的追求，支持ETC没有进行硬分叉的人坚持这种去“中心化的思想”）